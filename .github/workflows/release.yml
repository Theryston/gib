name: Release (auto bump + build + GitHub Release)

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: gib

jobs:
  prepare:
    # segurança extra contra loop (mesmo com a limitação do GITHUB_TOKEN)
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    outputs:
      released: ${{ steps.out.outputs.released }}
      version: ${{ steps.out.outputs.version }}
      tag: ${{ steps.out.outputs.tag }}
      sha: ${{ steps.out.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # instala binário pré-compilado do release-plz (bem mais rápido que cargo install)
      - name: Install release-plz
        uses: taiki-e/install-action@release-plz

      - name: Run release-plz update (bump + changelog)
        run: release-plz update

      - name: Commit + push + tag (only if changed)
        id: out
        shell: bash
        run: |
          set -euo pipefail

          # Se não mudou nada, não tem release
          if git diff --quiet; then
            echo "released=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          VERSION="$(python - <<'PY'
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path("Cargo.toml").read_text("utf-8"))
          print(data["package"]["version"])
          PY
          )"

          TAG="v${VERSION}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"       >> "$GITHUB_OUTPUT"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore(release): ${TAG}"

          # push do commit para main
          git push origin HEAD:main

          # cria/pusha tag
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists; aborting."
            exit 1
          fi

          git tag -a "${TAG}" -m "${TAG}"
          git push origin "${TAG}"

          SHA="$(git rev-parse HEAD)"
          echo "sha=${SHA}"       >> "$GITHUB_OUTPUT"
          echo "released=true"    >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    if: ${{ needs.prepare.outputs.released == 'true' }}
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz

          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true

          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

          - target: aarch64-pc-windows-msvc
            os: windows-latest
            archive: zip

          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz

          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz

    steps:
      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.sha }}
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/${{ env.BINARY_NAME }} dist/
          cd dist
          tar -czvf ${{ env.BINARY_NAME }}-${{ matrix.target }}.tar.gz ${{ env.BINARY_NAME }}
          rm ${{ env.BINARY_NAME }}

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/${{ env.BINARY_NAME }}.exe" -Destination "dist/"
          Compress-Archive -Path "dist/${{ env.BINARY_NAME }}.exe" -DestinationPath "dist/${{ env.BINARY_NAME }}-${{ matrix.target }}.zip"
          Remove-Item "dist/${{ env.BINARY_NAME }}.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.target }}
          path: dist/${{ env.BINARY_NAME }}-${{ matrix.target }}.${{ matrix.archive }}
          retention-days: 1

  release:
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.released == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files + checksums
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release/ \;
          cd release
          sha256sum * > checksums-sha256.txt

      - name: Create/Update GitHub Release and upload assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
          SHA: ${{ needs.prepare.outputs.sha }}
        shell: bash
        run: |
          set -euo pipefail

          prerelease_flag=""
          if [[ "$VERSION" == *-* ]]; then
            prerelease_flag="--prerelease"
          fi

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" release/* --clobber
          else
            gh release create "$TAG" release/* \
              --title "Release $TAG" \
              --generate-notes \
              --target "$SHA" \
              $prerelease_flag
          fi
